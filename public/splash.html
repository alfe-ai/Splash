<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alfe AI - AI Image Design and Software Development Platform</title>
  <link id="themeStylesheet" rel="stylesheet" href="/nexum.css" />
  <link id="favicon" rel="icon" type="image/x-icon" href="/alfe_favicon_64x64.ico" />
  <style>
    .app {
      display: none !important;
    }
    #startDialog {
      display: flex !important;
    }
    #logoText,
    #aboutLink,
    #sidebarToggle,
    #viewTabsBar,
    #cookieBanner {
      display: none !important;
    }

    .about-logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, #7a5dff, #4cc3ff);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      font-size: 0.95rem;
      letter-spacing: 0.05em;
    }

    #sidebarToggle.sidebar-toggle-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-color);
      font-size: 1.15rem;
      cursor: pointer;
    }

    #sidebarToggle.sidebar-toggle-icon:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    #storeBadges .store-badge {
      position: relative;
      display: inline-flex;
      opacity: 0.9;
    }

    #storeBadges .store-badge.disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    #storeBadges .store-badge.disabled::after {
      content: 'Soon';
      position: absolute;
      top: 42%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-20deg);
      background: var(--accent);
      color: #fff;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.8rem;
      pointer-events: none;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    #startDialog {
      --start-dialog-padding: clamp(0.65rem, 3vh, 1.5rem);
      overflow-x: hidden;
      overflow-y: auto;
      padding-block: var(--start-dialog-padding);
      padding-inline: clamp(0.75rem, 5vw, 2rem);
      padding-top: max(env(safe-area-inset-top), var(--start-dialog-padding));
      padding-bottom: max(env(safe-area-inset-bottom), var(--start-dialog-padding));
      box-sizing: border-box;
      min-height: 100vh;
      align-items: flex-start;
      align-content: center;
    }

    @supports (height: 100dvh) {
      #startDialog {
        min-height: 100dvh;
      }
    }

    #startDialog .modal-content {
      width: min(600px, 100%);
      margin-inline: auto;
      margin-block: clamp(0.45rem, 3vh, 1.25rem);
      padding: clamp(0.7rem, 3.5vw, 1.2rem);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: clamp(0.3rem, 1.5vh, 0.8rem);
      max-height: none;
      overflow: visible;
    }

    @supports (height: 100dvh) {
      #startDialog .modal-content {
        max-height: none;
      }
    }

    #startDialog .modal-content > * {
      width: 100%;
    }

    #startDialog .modal-title {
      width: 100%;
      color: var(--text-color);
      font-size: clamp(1.35rem, 6vw, 1.75rem);
      line-height: 1.15;
      text-align: center;
      margin-block: clamp(0.2rem, 1.2vh, 0.45rem);
    }

    #startDialog .splash-media p {
      font-size: clamp(1rem, 4.5vw, 1.1rem);
    }

    #startDialog .modal-content h3 {
      margin: clamp(0.2rem, 1.2vh, 0.4rem) 0 clamp(0.25rem, 1.5vh, 0.45rem);
      text-align: center;
    }

    #startDialog #startTypeButtons {
      gap: clamp(0.3rem, 1.2vw, 0.45rem);
    }

    #startDialog #startTypeButtons .start-type-btn,
    #newTabModal #newTabTypeButtons .start-type-btn {
      min-height: clamp(48px, 16vw, 60px);
      padding-block: clamp(0.25rem, 1.6vw, 0.45rem);
      font-size: clamp(0.93rem, 3.2vw, 1.02rem);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 4px;
      height: auto;
    }

    #startDialog #startTypeButtons .start-type-btn .icon,
    #newTabModal #newTabTypeButtons .start-type-btn .icon {
      font-size: clamp(1.1rem, 4vw, 1.3rem);
      margin-bottom: 1px;
    }

    #startDialog #startTypeButtons .start-type-btn.disabled,
    #newTabModal #newTabTypeButtons .start-type-btn.disabled {
      pointer-events: none;
      opacity: 0.65;
    }

    #startDialog #startTypeButtons .start-type-btn.disabled .self-hosting-cta,
    #newTabModal #newTabTypeButtons .start-type-btn.disabled .self-hosting-cta {
      pointer-events: auto;
    }

    .self-hosting-cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: clamp(0.65rem, 2.4vw, 0.75rem);
      font-weight: 600;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      text-decoration: none;
      text-align: center;
      white-space: nowrap;
      line-height: 1.2;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      max-width: 100%;
    }

    .self-hosting-cta:focus-visible {
      outline: 2px solid rgba(255, 255, 255, 0.85);
      outline-offset: 2px;
    }

    #startSocialLinks {
      line-height: 1.3;
      word-break: break-word;
      padding-inline: clamp(0.4rem, 3vw, 0.85rem);
    }

    @media (max-height: 640px) {
      #startDialog {
        align-items: flex-start;
      }

      #startDialog .modal-content {
        margin-block: clamp(0.5rem, 6vh, 1.5rem);
      }
    }

    @media (max-height: 560px) {
      #startDialog .modal-title {
        font-size: clamp(1.2rem, 5.5vw, 1.5rem);
      }

      #startDialogGif {
        max-height: clamp(160px, 52vh, 360px);
      }

      #startDialog .modal-content {
        gap: clamp(0.2rem, 1vh, 0.6rem);
      }

      #storeBadges {
        display: none;
      }

      #startTypeButtons .start-type-btn.disabled,
      #startSocialLinks {
        display: none;
      }
    }

    @media (max-width: 480px) {
      #startDialog .modal-content {
        padding: clamp(0.85rem, 6vw, 1.5rem);
      }

      #startDialog .splash-media h2 {
        font-size: clamp(1.2rem, 7vw, 1.6rem);
      }

      #startDialog .splash-media p {
        font-size: clamp(0.95rem, 5.5vw, 1.05rem);
      }

      #startSocialLinks {
        font-size: clamp(0.85rem, 4vw, 0.95rem);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <button id="sidebarToggle" class="sidebar-toggle-icon" type="button" title="Toggle sidebar" aria-label="Toggle sidebar">‚ò∞</button>
    <span id="logoText" style="position:absolute; top:12px; left:60px; font-size:1.4rem; color:var(--text-color);">Alfe AI</span>
    <a id="aboutLink" style="position:absolute; top:18px; left:130px; font-size:0.8rem; color:var(--text-color); cursor:pointer;">About</a>
    <aside id="sidebar">
      <div id="tabsList" style="position:relative; top: 40px;"></div>
      <div id="archiveList" style="position:relative; top: 40px; display:none;"></div>
      <button id="newTabBtn" style="position:relative; top: 40px;">New Tab</button>
    </aside>
    <main>
      <div id="viewTabsBar" style="display:flex;gap:0.5rem;margin-bottom:0.5rem;align-items:center;">
        <button id="viewTabChat" class="view-tab active" style="position:relative; left: 40px;">üí¨ Chat</button>
        <button id="viewTabTasks" class="view-tab" style="position:relative; left: 40px;">‚òëÔ∏è Tasks</button>
        <button id="viewTabArchive" class="view-tab" style="position:relative; left: 40px;">Archive</button>
        <button id="settingsBtn" title="Settings" style="margin-left:auto;background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;">&#9881;</button>
        <button id="feedbackBtn" title="Send Feedback" style="background:none;border:none;color:#ddd;font-size:1.2rem;cursor:pointer;margin-left:0.5rem;">üìù</button>
      </div>
<!--      <h1>Nexum Chat</h1>-->
      <div id="modelInfo" style="margin-bottom:0.5rem; color:#aaa;"></div>
      <div id="chatPanel">
        <div id="suggestions"></div>
        <div id="chat"></div>
        <div id="inputArea">
          <div id="promptWrapper" style="position:relative;display:inline-block;">
            <textarea id="prompt" rows="12" placeholder="Enter your message" style="width:100%;max-width:600px;"></textarea>
            <div id="taskBtns">
              <button id="askBtn" style="display:none;">Ask</button>
              <button id="codeBtn" style="display:none;">Code</button>
              <button id="renderBtn" style="display:none;">Render</button>
            </div>
          </div>
          <button id="sendBtn"><span id="sendBtnText">Chat</span></button>
        </div>
      </div>
      <div id="taskListPanel" style="display:none;">
        <h2 style="margin:0;font-size:1.1rem;">Tasks</h2>
        <table id="tasks">
          <thead><tr id="headerRow"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>
  <div id="settingsModal">
    <div class="modal-content">
      <h3>Nexum Settings</h3>
      <div>
        <h4>Nexum Feature Flags</h4>
        <!-- Chat and task tabs are now always visible -->
        <label style="display:block;"><input type="checkbox" id="flagShowDependencies"> Show "Depends On" Column</label>
        <label style="display:block;margin-top:0.2rem;"><input type="checkbox" id="flagShowArchived"> Show Archived Chats</label>
        <label style="display:block;margin-top:0.2rem;"><input type="checkbox" id="flagShowFeedback"> Show Feedback Button</label>
        <label style="display:block;margin-top:0.2rem;"><input type="checkbox" id="flagAuroraStart"> Use Aurora for New Chat</label>
      </div>
      <div style="margin-top:0.4rem;">
        <label>Color:
          <select id="themeColorSelect">
            <option value="purple">Purple</option>
            <option value="lightblue">Light Blue</option>
            <option value="red">Red</option>
            <option value="green">Green</option>
            <option value="orange">Orange</option>
            <option value="teal">Teal</option>
            <option value="pink">Pink</option>
          </select>
        </label>
        <label style="margin-left:0.5rem;">Mode:
          <select id="themeModeSelect">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
          </select>
        </label>
      </div>
      <button id="closeSettingsBtn" style="margin-top:0.75rem;">Close</button>
    </div>
  </div>
  <div id="feedbackModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h3>Send Feedback</h3>
      <label>Type:
        <select id="feedbackTypeSelect" style="width:100%;">
          <option value="feature">Feature Request</option>
          <option value="bug">Bug Report</option>
          <option value="misc">Misc</option>
        </select>
      </label>
      <textarea id="feedbackText" rows="4" style="width:100%;"></textarea>
      <div style="margin-top:0.75rem;text-align:right;">
        <button id="feedbackSubmitBtn">Submit</button>
        <button id="feedbackCancelBtn">Close</button>
      </div>
    </div>
  </div>
  <div id="tabConfigModal">
    <div class="modal-content">
      <h3>Tab Configuration</h3>
      <label>Project Name:<br/>
        <input type="text" id="tabProjectInput" style="width:100%;" />
      </label>
      <label style="margin-top:6px;">Git Repo SSH URL:<br/>
        <input type="text" id="tabRepoInput" style="width:100%;" />
      </label>
      <label style="margin-top:6px;">Tab Type:<br/>
        <select id="tabTypeSelect" style="width:100%;">
          <option value="chat">Chat</option>
          <option value="code">Code</option>
          <option value="design">Design</option>
          <option value="task">Project</option>
        </select>
      </label>
      <label style="margin-top:6px;">Codex Chat URL:<br/>
        <input type="text" id="codexChatUrlInput" style="width:100%;" />
      </label>
      <button id="codexImportBtn" style="margin-top:6px;">Codex/GitHub Import</button>
      <div style="margin-top:0.75rem;text-align:right;">
        <button id="tabConfigSaveBtn">Save</button>
        <button id="tabConfigCancelBtn">Cancel</button>
      </div>
    </div>
  </div>
  <div id="newTabModal" style="display:none;" class="modal">
    <div class="modal-content">
      <h3>New Tab</h3>
      <div>
        <div id="newTabTypeButtons">
          <button data-type="chat" class="start-type-btn selected">
            <div class="icon">üí¨</div>
            <div>Chat</div>
          </button>
          <div data-type="code" class="start-type-btn disabled" role="button" aria-disabled="true" tabindex="-1">
            <div class="icon">üíª</div>
            <div>Code</div>
            <a
              class="self-hosting-cta"
              href="https://github.com/alfe-ai/Sterling_MIT"
              target="_blank"
              rel="noopener noreferrer"
            >
              Self-Host Now
            </a>
          </div>
          <div data-type="design" class="start-type-btn disabled" role="button" aria-disabled="true" tabindex="-1">
            <div class="icon">üé®</div>
            <div>Design</div>
            <a
              class="self-hosting-cta"
              href="https://github.com/alfe-ai/alfe-ai-2.0_beta"
              target="_blank"
              rel="noopener noreferrer"
            >
              Self-Host Now
            </a>
          </div>
        </div>
        <label style="margin-top:6px;">Message:<br/>
          <textarea id="newTabChatInput" rows="3" style="width:100%;" placeholder="Start chatting..."></textarea>
        </label>
        <div id="newTabRepoSection" style="margin-top:6px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="newTabRepoInput" style="width:100%;" />
          </label>
          <div style="font-size:0.9rem; margin-top:3px;">
            note: We will update to do setup with GitHub connector/other external connectors/self host git/ AND THE URL SPECIFICATION FOR MANUAL REMOTE WILL ALSO BE AN OPTION AT THIS STEP, BUT AT THIS POINT, IT IS THE ONLY OPTION
          </div>
        </div>
      </div>
      <div style="margin-top:0.75rem;text-align:right;">
        <button id="newTabCreateBtn">Create</button>
        <button id="newTabCancelBtn">Close</button>
      </div>
    </div>
  </div>
  <div id="startDialog" class="modal" style="display:none;">
    <a href="/about.html" target="_blank" style="position:absolute; top:8px; left:8px; font-size:0.8rem; color:var(--text-color);">About</a>
    <div id="splashAnim" aria-hidden="true">
      <div id="splashTitle">Nexum</div>
    </div>
    <div class="modal-content">
      <h2 class="modal-title">Alfe AI</h2>
      <div class="splash-media" style="display:flex; flex-direction:column; align-items:center; gap:0.45rem; margin-bottom:0.45rem;">
        <p
          id="privacyTagline"
          style="margin:0; font-size:1.05rem; color:var(--text-color); opacity:0.8; text-align:center;"
        >
          Secure, Open-source AI Workspace
        </p>
        <img
          id="startDialogGif"
          src="/demo2.gif"
          alt="Alfe AI demo"
          style="max-width:960px; width:100%; height:auto; max-height:clamp(180px, 60vh, 480px); object-fit:contain; cursor:pointer;"
        />
      </div>
      <h3>Get Started</h3>
      <div>
        <div id="startTypeButtons">
          <button data-type="chat" class="start-type-btn">
            <div class="icon">üí¨</div>
            <div>Chat</div>
          </button>
          <div data-type="search" class="start-type-btn disabled" role="button" aria-disabled="true" tabindex="-1">
            <div class="icon">üåê</div>
            <div>Search</div>
            <a
              class="self-hosting-cta"
              href="https://github.com/alfe-ai/alfe-ai-2.0_beta"
              target="_blank"
              rel="noopener noreferrer"
            >
              Self-Host Now
            </a>
          </div>
          <div data-type="design" class="start-type-btn disabled" role="button" aria-disabled="true" tabindex="-1">
            <div class="icon">üé®</div>
            <div>Design</div>
            <a
              class="self-hosting-cta"
              href="https://github.com/alfe-ai/alfe-ai-2.0_beta"
              target="_blank"
              rel="noopener noreferrer"
            >
              Self-Host Now
            </a>
          </div>
          <div data-type="code" class="start-type-btn disabled" role="button" aria-disabled="true" tabindex="-1">
            <div class="icon">üíª</div>
            <div>Code</div>
            <a
              class="self-hosting-cta"
              href="https://github.com/alfe-ai/Sterling_MIT"
              target="_blank"
              rel="noopener noreferrer"
            >
              Self-Host Now
            </a>
          </div>
          <button data-type="task" class="start-type-btn disabled" disabled>
            <div class="icon">üìã</div>
            <div>Project</div>
          </button>
        </div>
        <div id="startRepoSection" style="margin-top:6px; display:none;">
          <label>Git Repo SSH URL:<br/>
            <input type="text" id="startRepoInput" style="width:100%;" />
          </label>
          <div style="font-size:0.9rem; margin-top:3px;">
            note: We will update to do setup with GitHub connector/other external connectors/self host git/ AND THE URL SPECIFICATION FOR MANUAL REMOTE WILL ALSO BE AN OPTION AT THIS STEP, BUT AT THIS POINT, IT IS THE ONLY OPTION
          </div>
        </div>
      </div>
      <div id="storeBadges" style="margin-top:0.4rem; display:flex; justify-content:center; gap:0.6rem; flex-wrap:wrap;">
        <a
          class="store-badge disabled"
          href="https://play.google.com/store/apps"
          target="_blank"
          rel="noopener noreferrer"
          title="Get it on Google Play"
          style="display:inline-flex;"
        >
          <img
            src="https://play.google.com/intl/en_us/badges/static/images/badges/en_badge_web_generic.png"
            alt="Get it on Google Play"
            style="height:56px; width:auto;"
          />
        </a>
        <a
          class="store-badge disabled"
          href="https://www.apple.com/app-store/"
          target="_blank"
          rel="noopener noreferrer"
          title="Download on the App Store"
          style="display:inline-flex;"
        >
          <img
            src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg"
            alt="Download on the App Store"
            style="height:37px; width:auto; position: relative; top: 9px;"
          />
        </a>
      </div>
      <div id="startSocialLinks" style="margin-top:0.3rem; text-align:center;">
        <a href="/about.html" target="_blank">About</a> |
        <a href="https://github.com/alfe-ai/alfe-ai-2.0_beta">GitHub</a> |
        <a href="https://bsky.app/profile/alfeai.bsky.social">Bluesky</a><!-- | -->
        <!--<a href="https://mastodon.social/@alfeai">Mastodon</a>--><!-- | -->
        <!-- <a href="https://www.reddit.com/">Reddit</a> | -->
        <!-- <a href="https://www.linkedin.com/">LinkedIn</a> | -->
        <!-- <a href="https://x.com/">X (Twitter)</a> -->
        <!-- Discord -->
        <!-- Matrix -->
      </div>
    </div>
  </div>
  <div id="aboutOverlay" style="display:none;" class="modal">
    <div style="padding:0.8rem; width:100%; height:100%; overflow:auto; display:flex; flex-direction:column;">
      <div style="display:flex; align-items:center;">
        <div class="about-logo" aria-hidden="true">AA</div>
        <span id="backToApp" style="margin-left:8px; cursor:pointer;">&larr; Back to App</span>
      </div>
      <div style="margin-top:0.75rem; font-size:0.9rem; line-height:1.35;">
        <p><strong>About Alfe AI</strong></p>
        <p>Alfe AI is an open source platform that combines AI-assisted image design, software development, and task management.</p>
        <p>All source code is available on <a href="https://github.com/alfe-ai/alfe-ai-Aurelix" target="_blank">GitHub</a> for self-hosting or customization. Alfe AI has a Privacy-by-Default philosophy, and your data is only used for purposes required by the application. Data is not sold or used for advertising. When using 3rd party LLM providers, we only use providers that do not train on your data.</p>
        <p>Alfe AI is Developed by <a href="https://lochner.tech" target="_blank">Lochner Tech</a>.</p>
        <p><strong>Our Story</strong></p>
        <p>We started in 2022 with a task management prototype called Aurora. The idea matured into Nexum, and by May 2025 we're focusing on integrating AI tools to streamline developer workflows.</p>
        <p id="sessionIdDisplay" style="margin-top:0.35rem; display:none;">Session ID: <span id="sessionIdText"></span></p>
      </div>
    </div>
  </div>
  <script src="/session.js"></script>
  <script>

    let tabs = [];
    let archivedTabs = [];
    let currentTabId = 1;
    let currentView = 'chat';
    let currentTasks = [];
    let taskSortColumn = 'priority';
    let taskSortAsc = true;
    let showDependencies = false;
    let showArchived = false;
    let showFeedbackButton = true;
    let startInAurora = true;
    // Feature flag to enable advanced start options (Code, Design, Project)
    const splashOnlyMode = true;
    const auroraRedirectUrl = 'https://mvp2.alfe.sh/aurora.html';
    const auroraRedirectCookie = 'splashAutoRedirect';
    // Maintain a history of user-entered prompts
    const inputHistory = [];
    let inputHistoryPos = -1;
    const taskColumns = [
      {key:'priority', label:'Prio'},
      {key:'status', label:'Status'},
      {key:'number', label:'#'},
      {key:'title', label:'Title'},
      {key:'dependencies', label:'Depends On'},
      {key:'project', label:'Project'},
      {key:'created', label:'Created'}
    ];
    const suggestions = [
      'Code a Pong Clone in JavaScript',
      'Create a basic to-do list in Python',
      'Explain how recursion works',
      'Design a responsive navbar'
    ];

    let currentColor = 'purple';
    let currentMode = 'dark';

    let splashTimer = null;

    function startSplash(){
      // Scrolling text disabled.
    }

    function stopSplash(){
      if(splashTimer !== null){
        clearTimeout(splashTimer);
        splashTimer = null;
      }
    }

    function rememberAuroraRedirectPreference(){
      setCookie(auroraRedirectCookie, '1');
    }

    function shouldAutoRedirectToAurora(){
      return getCookie(auroraRedirectCookie) === '1';
    }

    function enforceSplashOnlyMode(){
      if(!splashOnlyMode) return;
      const app = document.querySelector('.app');
      if(app) app.style.display = 'none';
      const dlg = document.getElementById('startDialog');
      if(dlg){
        dlg.style.display = 'flex';
        startSplash();
      }
      const sidebarToggle = document.getElementById('sidebarToggle');
      if(sidebarToggle) sidebarToggle.style.display = 'none';
      const logoText = document.getElementById('logoText');
      if(logoText) logoText.style.display = 'none';
      const aboutLink = document.getElementById('aboutLink');
      if(aboutLink) aboutLink.style.display = 'none';
      const topBar = document.getElementById('viewTabsBar');
      if(topBar) topBar.style.display = 'none';
    }

    async function loadTheme(){
      try{
        const resColor = await fetch('/api/settings/nexum_theme_color');
        const resMode = await fetch('/api/settings/nexum_theme_mode');
        if(resColor.ok){
          const data = await resColor.json();
          currentColor = data.value || 'purple';
        } else { currentColor = 'purple'; }
        if(resMode.ok){
          const data = await resMode.json();
          currentMode = data.value || 'dark';
        } else { currentMode = 'dark'; }
        const selColor = document.getElementById('themeColorSelect');
        if(selColor) selColor.value = currentColor;
        const selMode = document.getElementById('themeModeSelect');
        if(selMode) selMode.value = currentMode;
        applyTheme(currentColor, currentMode);
      }catch(e){ applyTheme('purple','dark'); console.error(e); }
    }

    function applyTheme(color, mode){
      const link = document.getElementById('themeStylesheet');
      if(!link) return;
      const files = {
        purple: {dark:'/nexum.css', light:'/nexum_purple_light.css'},
        lightblue: {dark:'/nexum_lightblue.css', light:'/nexum_lightblue_light.css'},
        red: {dark:'/nexum_red.css', light:'/nexum_red_light.css'},
        green: {dark:'/nexum_green.css', light:'/nexum_green_light.css'},
        orange: {dark:'/nexum_orange.css', light:'/nexum_orange_light.css'},
        teal: {dark:'/nexum_teal.css', light:'/nexum_teal_light.css'},
        pink: {dark:'/nexum_pink.css', light:'/nexum_pink_light.css'}
      };
      link.href = files[color]?.[mode] || '/nexum.css';
    }
    const urlParams = new URLSearchParams(location.search);
    const startTab = parseInt(urlParams.get('tabId'), 10);
    if(!Number.isNaN(startTab)) currentTabId = startTab;


    async function loadModelInfo(){
      try{
        const res = await fetch('/api/model');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('modelInfo').textContent = 'Model: ' + (data.model || 'unknown');
      }catch(e){console.error(e);}
    }

    async function loadTabs(){
      try{
        const res = await fetch('/api/chat/tabs?nexum=1&showArchived=' + (showArchived ? '1' : '0'));
        if(res.ok){
          tabs = await res.json();
        } else {
          tabs = [];
        }
      }catch(e){ tabs = []; console.error(e); }
    }

  function renderTabs(){
    const container = document.getElementById('tabsList');
    container.innerHTML = '';
    tabs.forEach(t => {
        const item = document.createElement('div');
        item.className = 'tab-item';

        const b = document.createElement('button');
        const icon = document.createElement('span');
        icon.className = 'type-icon';
        icon.textContent = t.tab_type === 'task' ? '</>' : 'üí¨';
        b.appendChild(document.createTextNode(t.name));
        b.appendChild(icon);
        if(t.id === currentTabId) b.classList.add('active');
        b.addEventListener('click', () => {
          currentTabId = t.id;
          applyTabView();
          renderTabs();
        });
        b.addEventListener('contextmenu', e => {
          e.preventDefault();
          const choice = prompt("Type 'rename' or 'delete':", "");
          if(choice === 'rename') renameTab(t.id);
          else if(choice === 'delete') deleteTab(t.id);
        });

        const gear = document.createElement('button');
        gear.innerHTML = '&#9881;';
        gear.className = 'config-btn';
        gear.addEventListener('click', (e) => { e.stopPropagation(); openTabConfig(t.id); });

        const renameBtn = document.createElement('button');
        renameBtn.textContent = 'Rename';
        renameBtn.className = 'config-btn';
        renameBtn.addEventListener('click', e => { e.stopPropagation(); renameTab(t.id); });

        const archBtn = document.createElement('button');
        archBtn.innerHTML = t.archived ? 'Unarchive' : '&#128452;';
        archBtn.title = t.archived ? 'Unarchive' : 'Archive';
        archBtn.className = 'config-btn';
        archBtn.addEventListener('click', e => {
          e.stopPropagation();
          toggleArchiveTab(t.id, !t.archived);
        });

        item.appendChild(b);
        item.appendChild(gear);
        item.appendChild(renameBtn);
        item.appendChild(archBtn);
      container.appendChild(item);
    });
    checkNoTabsDialog();
  }

  function checkNoTabsDialog(){
    if(splashOnlyMode){
      enforceSplashOnlyMode();
      return;
    }
    const dlg = document.getElementById('startDialog');
    if(!dlg) return;
    const noTabs = tabs.length === 0;
    dlg.style.display = noTabs ? 'flex' : 'none';
    if(noTabs){
      startSplash();
      // start suggestions disabled
    } else {
      stopSplash();
      // start suggestions disabled
    }
    const chatPanel = document.getElementById('chatPanel');
    if(chatPanel) chatPanel.style.display = noTabs ? 'none' : '';
    const taskPanel = document.getElementById('taskListPanel');
    if(taskPanel) taskPanel.style.display = noTabs ? 'none' : (currentView === 'tasks' ? '' : 'none');
  }

  async function loadArchivedTabs(){
    try{
      const res = await fetch('/api/chat/tabs?nexum=1&showArchived=1');
      if(res.ok){
        archivedTabs = (await res.json()).filter(t => t.archived);
      }else{
        archivedTabs = [];
      }
    }catch(e){ archivedTabs = []; console.error(e); }
  }

  function renderArchivedTabs(){
    const container = document.getElementById('archiveList');
    container.innerHTML = '';
    archivedTabs.forEach(t => {
      const item = document.createElement('div');
      item.className = 'tab-item';

      const info = document.createElement('div');
      info.style.display = 'flex';
      info.style.flexDirection = 'column';
      info.style.flexGrow = '1';

      const label = document.createElement('span');
      label.textContent = t.name;

      const date = document.createElement('span');
      date.className = 'tab-date';
      date.style.fontSize = '0.8rem';
      date.style.opacity = '0.8';
      date.textContent = `Created ${isoDate(t.created_at)} \u2022 Archived ${isoDate(t.archived_at)}`;

      info.appendChild(label);
      info.appendChild(date);
      const unarch = document.createElement('button');
      unarch.textContent = 'Unarchive';
      unarch.className = 'config-btn';
      unarch.addEventListener('click', () => toggleArchiveTab(t.id, false));
      item.appendChild(info);
      item.appendChild(unarch);
      container.appendChild(item);
    });
  }

    function isoDate(d){
      return new Date(d).toLocaleDateString([], {year:'2-digit',month:'2-digit',day:'2-digit'});
    }

    function sortTasks(){
      if(!showDependencies && taskSortColumn === 'dependencies'){
        taskSortColumn = 'priority';
      }
      currentTasks.sort((a,b)=>{
        let va = a[taskSortColumn];
        let vb = b[taskSortColumn];
        if(taskSortColumn === 'created'){
          va = new Date(a.created_at);
          vb = new Date(b.created_at);
        }
        if(typeof va === 'string') va = va.toLowerCase();
        if(typeof vb === 'string') vb = vb.toLowerCase();
        if(va < vb) return taskSortAsc ? -1 : 1;
        if(va > vb) return taskSortAsc ? 1 : -1;
        return 0;
      });
    }

    function renderTaskHeader(){
      const tr = document.getElementById('headerRow');
      if(!tr) return;
      tr.innerHTML = '';
      taskColumns.forEach(col => {
        if(!showDependencies && col.key === 'dependencies') return;
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.key = col.key;
        th.style.cursor = 'pointer';
        if(taskSortColumn === col.key) th.textContent += taskSortAsc ? ' \u25B2' : ' \u25BC';
        th.addEventListener('click', () => {
          if(taskSortColumn === col.key){
            taskSortAsc = !taskSortAsc;
          } else {
            taskSortColumn = col.key;
            taskSortAsc = true;
          }
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        });
        tr.appendChild(th);
      });
    }

    function renderTasks(tasks){
      const tbody = document.querySelector('#tasks tbody');
      if(!tbody) return;
      tbody.innerHTML = '';
      tasks.forEach(t => {
        const tr = document.createElement('tr');
        taskColumns.forEach(col => {
          if(!showDependencies && col.key === 'dependencies') return;
          const td = document.createElement('td');
          switch(col.key){
            case 'number':
              td.innerHTML = `<a href="${t.html_url}" target="_blank">#${t.number}</a>`;
              break;
            case 'created':
              td.textContent = isoDate(t.created_at);
              break;
            default:
              td.textContent = t[col.key] || '';
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadTasksForCurrentProject(){
      const t = tabs.find(tt => tt.id === currentTabId);
      let url;
      if(!t || !t.project_name){
        url = '/api/tasks';
      }else{
        url = '/api/projects/' + encodeURIComponent(t.project_name);
      }
      try{
        const res = await fetch(url);
        if(res.ok){
          currentTasks = await res.json();
          sortTasks();
          renderTaskHeader();
          renderTasks(currentTasks);
        }else{
          currentTasks = [];
          renderTasks([]);
        }
      }catch(e){
        console.error(e);
        currentTasks = [];
        renderTasks([]);
      }
    }

    function renderSuggestions(show = true, id = 'suggestions', inputId = 'prompt'){
      const container = document.getElementById(id);
      if(!container) return;
      container.innerHTML = '';
      container.style.display = show ? 'grid' : 'none';
      if(!show) return;
      suggestions.forEach(text => {
        const b = document.createElement('button');
        b.textContent = text;
        b.addEventListener('click', () => {
          const inp = document.getElementById(inputId);
          if(inp){
            inp.value = text;
            inp.focus();
          }
        });
        container.appendChild(b);
      });
    }

    async function loadHistory(){
      try{
        const res = await fetch(`/api/chat/history?tabId=${currentTabId}&limit=20&offset=0`);
        if(!res.ok) return;
        const data = await res.json();
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        (data.pairs || []).reverse().forEach(p => {
          addMsg('user', p.user_text);
          if(p.ai_text) addMsg('ai', p.ai_text);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
        renderSuggestions((data.pairs || []).length === 0, 'suggestions', 'prompt');
      }catch(e){console.error(e);}
    }
    function addMsg(role,text){
      const el=document.createElement('div');
      el.className='msg '+(role==='user'?'user':'ai');
      el.textContent=text;
      document.getElementById('chat').appendChild(el);
    }
    let newTabSelectedType = 'chat';

    function openNewTabModal(){
      newTabSelectedType = 'chat';
      document.getElementById('newTabChatInput').value = '';
      document.getElementById('newTabRepoInput').value = '';
      document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
      const first = document.querySelector('#newTabTypeButtons .start-type-btn[data-type="chat"]');
      if(first) first.classList.add('selected');
      handleNewTabTypeChange();
      document.getElementById('newTabModal').style.display = 'flex';
    }
    async function createNewTab(){
      const type = newTabSelectedType;
      const message = document.getElementById('newTabChatInput').value.trim();
      const repo = document.getElementById('newTabRepoInput').value.trim();
      const body = { name:'New Tab', nexum:1, type, project:'', repo, sessionId };
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){
        const data = await r.json();
        document.getElementById('newTabModal').style.display = 'none';
        await loadTabs();
        currentTabId = data.id;
        renderTabs();
        if(message){
          document.getElementById('prompt').value = message;
          await send();
        }
        applyTabView();
      }
    }

    function handleNewTabTypeChange(){
      const section = document.getElementById('newTabRepoSection');
      if(section) section.style.display = newTabSelectedType === 'code' ? '' : 'none';
    }

    async function createStartTab(type){
      const repoEl = document.getElementById('startRepoInput');
      const repo = repoEl ? repoEl.value.trim() : '';
      const body = { name:'New Tab', nexum: startInAurora ? 0 : 1, type, project:'', repo, sessionId };
      const r = await fetch('/api/chat/tabs/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      if(r.ok){
        const data = await r.json();
        if(!splashOnlyMode){
          document.getElementById('startDialog').style.display = 'none';
          stopSplash();
        }
        if(startInAurora){
          await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'last_chat_tab', value:data.id})});
          location.href = '/aurora.html';
          return;
        }
        await loadTabs();
        currentTabId = data.id;
        renderTabs();
        applyTabView();
      }
    }
    async function renameTab(tabId){
      const t = tabs.find(tt => tt.id === tabId);
      const newName = prompt("New name:", t ? t.name : "");
      if(!newName) return;
      try{
        const r = await fetch("/api/chat/tabs/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tabId,newName})});
        if(r.ok){
          await loadTabs();
          renderTabs();
        }
      }catch(e){console.error(e);}
    }

    async function deleteTab(tabId){
      if(!confirm('Are you sure you want to delete this tab (and all its messages)?')) return;
      try{
        const r = await fetch('/api/chat/tabs/' + tabId,{method:'DELETE'});
        if(r.ok){
          await loadTabs();
          if(tabs.length>0){
            currentTabId = tabs[0].id;
          }else{
            currentTabId = 1;
          }
          renderTabs();
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    async function toggleArchiveTab(tabId, archived){
      try{
        const r = await fetch('/api/chat/tabs/archive',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, archived})});
        if(r.ok){
          await loadTabs();
          renderTabs();
          if(currentView === 'archive') {
            await loadArchivedTabs();
            renderArchivedTabs();
          }
          if(currentView === 'chat') loadHistory();
          if(currentView === 'tasks') loadTasksForCurrentProject();
        }
      }catch(e){console.error(e);}
    }

    function openTabConfig(tabId){
      const t = tabs.find(tt => tt.id === tabId) || {};
      document.getElementById('tabProjectInput').value = t.project_name || '';
      document.getElementById('tabRepoInput').value = t.repo_ssh_url || '';
      document.getElementById('tabTypeSelect').value = t.tab_type || 'chat';
      const modal = document.getElementById('tabConfigModal');
      modal.dataset.tabId = tabId;
      modal.style.display = 'flex';
    }

    function updateView(v){
      currentView = v;
      document.getElementById('viewTabChat').classList.toggle('active', v === 'chat');
      document.getElementById('viewTabTasks').classList.toggle('active', v === 'tasks');
      document.getElementById('viewTabArchive').classList.toggle('active', v === 'archive');

      const sendBtn = document.getElementById('sendBtn');
      const askBtn = document.getElementById('askBtn');
      const renderBtn = document.getElementById('renderBtn');
      const codeBtn = document.getElementById('codeBtn');
      if(sendBtn && askBtn && renderBtn && codeBtn){
        const t = tabs.find(tt => tt.id === currentTabId) || {};
        const type = t.tab_type || 'chat';
        const hasRepo = !!(t.repo_ssh_url && t.repo_ssh_url.trim());
        const isCode = type === 'code';
        if(v === 'chat'){
          sendBtn.style.display = '';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        } else {
          sendBtn.style.display = 'none';
          renderBtn.style.display = '';
          askBtn.style.display = isCode ? '' : 'none';
          codeBtn.style.display = isCode && hasRepo ? '' : 'none';
        }
      }

      const taskPanel = document.getElementById('taskListPanel');
      if(taskPanel) taskPanel.style.display = v === 'tasks' ? '' : 'none';
      const archiveList = document.getElementById('archiveList');
      if(archiveList) archiveList.style.display = v === 'archive' ? '' : 'none';
      const tabsListEl = document.getElementById('tabsList');
      if(tabsListEl) tabsListEl.style.display = v === 'archive' ? 'none' : '';
      const newTabBtnEl = document.getElementById('newTabBtn');
      if(newTabBtnEl) newTabBtnEl.style.display = v === 'archive' ? 'none' : '';

      const chatEl = document.getElementById('chat');
      if(chatEl) chatEl.style.display = v === 'tasks' || v === 'archive' ? 'none' : '';
      const suggestionsEl = document.getElementById('suggestions');
      if(suggestionsEl) suggestionsEl.style.display = v === 'tasks' || v === 'archive' ? 'none' : '';

      const chatPanel = document.getElementById('chatPanel');
      if(chatPanel){
        chatPanel.classList.toggle('tasks-view', v === 'tasks');
        chatPanel.style.display = v === 'archive' ? 'none' : '';
      }

      if(v === 'chat') {
        loadHistory();
      }
      if(v === 'tasks') {
        renderTaskHeader();
        loadTasksForCurrentProject();
      }
      if(v === 'archive') {
        loadArchivedTabs().then(renderArchivedTabs);
      }
    }

    function applyTabView(){
      if(tabs.length === 0){
        const chatPanel = document.getElementById('chatPanel');
        if(chatPanel) chatPanel.style.display = 'none';
        const taskPanel = document.getElementById('taskListPanel');
        if(taskPanel) taskPanel.style.display = 'none';
        return;
      }
      const t = tabs.find(tt => tt.id === currentTabId);
      const isTask = t && t.tab_type === 'task';
      updateView(isTask ? 'tasks' : 'chat');
    }


      async function send(){
        const promptEl=document.getElementById('prompt');
        const text=promptEl.value.trim();
        if(!text) return;
        inputHistory.push(text);
        inputHistoryPos = -1;
        renderSuggestions(false, 'suggestions', 'prompt');
        addMsg('user',text);
        promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const resp=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,tabId:currentTabId,sessionId})});
        if(!resp.ok||!resp.body){aiEl.textContent='[error]';return;}
        const reader=resp.body.getReader();
        const dec=new TextDecoder();
        let done=false;let result='';
        while(!done){
          const {value,done:doneR}=await reader.read();
          done=doneR;
          if(value){result+=dec.decode(value);aiEl.textContent=result;document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;}
        }
      }catch(e){aiEl.textContent='[error]';console.error(e);}
    }
    async function createTask(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      inputHistory.push(text);
      inputHistoryPos = -1;
      const tab=tabs.find(tt=>tt.id===currentTabId) || {};
      const project=tab.project_name || '';
      promptEl.value='';
      try{
        await fetch('/api/tasks/new',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:text, project})});
        await loadTasksForCurrentProject();
      }catch(e){console.error(e);}
    }

    async function generateImage(){
      const promptEl=document.getElementById('prompt');
      const text=promptEl.value.trim();
      if(!text) return;
      inputHistory.push(text);
      inputHistoryPos = -1;
      addMsg('user', text);
      promptEl.value='';
      const aiEl=document.createElement('div');
      aiEl.className='msg ai';
      aiEl.textContent='...';
      document.getElementById('chat').appendChild(aiEl);
      document.getElementById('chat').scrollTop=document.getElementById('chat').scrollHeight;
      try{
        const payload={prompt:text, tabId:currentTabId, sessionId};
        console.debug('Sending /api/image/generate', payload);
        const resp=await fetch('/api/image/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        console.debug('/api/image/generate status', resp.status);
        const raw=await resp.clone().text().catch(()=>'' );
        console.debug('/api/image/generate body', raw);
        const data=await resp.json().catch(e=>{console.error('JSON parse error',e);return{}});
        if(resp.ok && data.url){
          aiEl.textContent='';
          const img=document.createElement('img');
          img.src=data.url;
          img.alt=text;
          img.style.maxWidth='100%';
          aiEl.appendChild(img);
        }else{
          aiEl.textContent=data.error||'[error]';
        }
      }catch(e){
        aiEl.textContent='[error]';
        console.error(e);
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      if(shouldAutoRedirectToAurora()){
        window.location.replace(auroraRedirectUrl);
        return;
      }

      enforceSplashOnlyMode();
      // Display the generated session ID in the About overlay
      const sessEl = document.getElementById('sessionIdText');
      if(sessEl) sessEl.textContent = sessionId;
      fetch('/api/settings/show_session_id')
        .then(r => r.ok ? r.json() : { value: false })
        .then(d => {
          const show = d.value !== false;
          const displayEl = document.getElementById('sessionIdDisplay');
          if(displayEl) displayEl.style.display = show ? 'block' : 'none';
        })
        .catch(() => {});

      const startDialogGif = document.getElementById('startDialogGif');
      if(startDialogGif){
        startDialogGif.addEventListener('click', () => {
          rememberAuroraRedirectPreference();
          window.location.href = auroraRedirectUrl;
        });
      }

      document.getElementById('sendBtn').addEventListener('click',send);
      document.getElementById('askBtn').addEventListener('click',send);
      document.getElementById('codeBtn').addEventListener('click',createTask);
      document.getElementById('renderBtn').addEventListener('click',generateImage);
    document.getElementById('prompt').addEventListener('keydown', e => {
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    document.getElementById('newTabBtn').addEventListener('click', openNewTabModal);
    document.getElementById('newTabCreateBtn').addEventListener('click', createNewTab);
    document.getElementById('newTabCancelBtn').addEventListener('click', () => {
      document.getElementById('newTabModal').style.display = 'none';
    });
    document.getElementById('newTabModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });
    document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if(btn.disabled || btn.dataset.disabled === 'true') return;
        newTabSelectedType = btn.dataset.type;
        document.querySelectorAll('#newTabTypeButtons .start-type-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        handleNewTabTypeChange();
      });
    });
    document.querySelectorAll('#startTypeButtons .start-type-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        if(btn.disabled || btn.dataset.disabled === 'true') return;
        if(btn.dataset.type === 'chat'){
          rememberAuroraRedirectPreference();
          window.location.href = auroraRedirectUrl;
          return;
        }
        createStartTab(btn.dataset.type);
      });
    });
    document.querySelectorAll('.self-hosting-cta').forEach(link => {
      link.addEventListener('click', e => {
        e.stopPropagation();
      });
    });
    document.getElementById('viewTabChat').addEventListener('click', () => updateView('chat'));
    document.getElementById('viewTabTasks').addEventListener('click', () => updateView('tasks'));
    document.getElementById('viewTabArchive').addEventListener('click', () => updateView('archive'));

    function applyFeatureFlags(){
      const chatBtn = document.getElementById('viewTabChat');
      if(chatBtn) chatBtn.style.display = '';
      const disableTypes = ['search','code','design','task'];
      ['search','code','design','task'].forEach(t => {
        const disabled = disableTypes.includes(t);
        const btn = document.querySelector(`#startTypeButtons .start-type-btn[data-type="${t}"]`);
        if(btn){
          btn.classList.toggle('disabled', disabled);
          btn.disabled = disabled;
          btn.dataset.disabled = disabled ? 'true' : 'false';
          if(btn.tagName !== 'BUTTON'){
            if(disabled){
              btn.setAttribute('aria-disabled', 'true');
              btn.setAttribute('tabindex', '-1');
            } else {
              btn.removeAttribute('aria-disabled');
              btn.setAttribute('tabindex', '0');
            }
          }
        }
        const newBtn = document.querySelector(`#newTabTypeButtons .start-type-btn[data-type="${t}"]`);
        if(newBtn){
          newBtn.classList.toggle('disabled', disabled);
          newBtn.disabled = disabled;
          newBtn.dataset.disabled = disabled ? 'true' : 'false';
          if(newBtn.tagName !== 'BUTTON'){
            if(disabled){
              newBtn.setAttribute('aria-disabled', 'true');
              newBtn.setAttribute('tabindex', '-1');
            } else {
              newBtn.removeAttribute('aria-disabled');
              newBtn.setAttribute('tabindex', '0');
            }
          }
        }
      });
      showDependencies = localStorage.getItem('flagShowDependencies') === 'true';
      showArchived = localStorage.getItem('flagShowArchived') === 'true';
      showFeedbackButton = localStorage.getItem('flagShowFeedback') !== 'false';
      startInAurora = localStorage.getItem('flagAuroraStart') !== 'false';
      const cbDeps = document.getElementById('flagShowDependencies');
      if(cbDeps) cbDeps.checked = showDependencies;
      const cbArch = document.getElementById('flagShowArchived');
      if(cbArch) cbArch.checked = showArchived;
      const cbFeedback = document.getElementById('flagShowFeedback');
      if(cbFeedback) cbFeedback.checked = showFeedbackButton;
      const cbAurora = document.getElementById('flagAuroraStart');
      if(cbAurora) cbAurora.checked = startInAurora;
      const feedbackBtn = document.getElementById('feedbackBtn');
      if(feedbackBtn) feedbackBtn.style.display = showFeedbackButton ? '' : 'none';
      if(currentView === 'tasks'){
        renderTaskHeader();
        renderTasks(currentTasks);
      }
    }

    document.getElementById('flagShowDependencies').addEventListener('change', e => {
      localStorage.setItem('flagShowDependencies', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagShowArchived').addEventListener('change', e => {
      localStorage.setItem('flagShowArchived', e.target.checked);
      applyFeatureFlags();
      loadTabs().then(renderTabs);
    });

    document.getElementById('flagShowFeedback').addEventListener('change', e => {
      localStorage.setItem('flagShowFeedback', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('flagAuroraStart').addEventListener('change', e => {
      localStorage.setItem('flagAuroraStart', e.target.checked);
      applyFeatureFlags();
    });

    document.getElementById('themeColorSelect').addEventListener('change', async e => {
      currentColor = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_color', value: currentColor})});
    });
    document.getElementById('themeModeSelect').addEventListener('change', async e => {
      currentMode = e.target.value;
      applyTheme(currentColor, currentMode);
      await fetch('/api/settings', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({key:'nexum_theme_mode', value: currentMode})});
    });

    document.getElementById('settingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'flex';
    });
    document.getElementById('closeSettingsBtn').addEventListener('click', () => {
      document.getElementById('settingsModal').style.display = 'none';
    });
    document.getElementById('settingsModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('feedbackBtn').addEventListener('click', () => {
      document.getElementById('feedbackModal').style.display = 'flex';
    });
    document.getElementById('feedbackCancelBtn').addEventListener('click', () => {
      document.getElementById('feedbackModal').style.display = 'none';
    });
    document.getElementById('feedbackSubmitBtn').addEventListener('click', async () => {
      const msg = document.getElementById('feedbackText').value;
      const type = document.getElementById('feedbackTypeSelect').value;
      await fetch('/api/feedback', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: msg, type})});
      document.getElementById('feedbackModal').style.display = 'none';
      document.getElementById('feedbackText').value = '';
    });
    document.getElementById('feedbackModal').addEventListener('click', e => {
      if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
    });

    document.getElementById('aboutLink').addEventListener('click', () => {
      document.getElementById('aboutOverlay').style.display = 'flex';
    });
    document.getElementById('backToApp').addEventListener('click', () => {
      document.getElementById('aboutOverlay').style.display = 'none';
    });

    document.getElementById('tabConfigSaveBtn').addEventListener('click', async () => {
      const modal = document.getElementById('tabConfigModal');
      const tabId = parseInt(modal.dataset.tabId, 10);
      const project = document.getElementById('tabProjectInput').value;
      const repo = document.getElementById('tabRepoInput').value;
      const type = document.getElementById('tabTypeSelect').value;
      await fetch('/api/chat/tabs/config', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({tabId, project, repo, type})});
      modal.style.display = 'none';
      await loadTabs();
      renderTabs();
      applyTabView();
      if(currentView === 'tasks') loadTasksForCurrentProject();
    });
    document.getElementById('tabConfigCancelBtn').addEventListener('click', () => {
      document.getElementById('tabConfigModal').style.display = 'none';
    });
      document.getElementById('tabConfigModal').addEventListener('click', e => {
        if(e.target === e.currentTarget) e.currentTarget.style.display = 'none';
      });

      async function init(){
        loadModelInfo();
        await loadTheme();
        applyFeatureFlags();
        await loadTabs();
        await loadArchivedTabs();
        if(tabs.length>0){
          if(!Number.isNaN(startTab) && tabs.some(t=>t.id===startTab)){
            currentTabId = startTab;
          }else{
            currentTabId = tabs[0].id;
          }
        }
        renderTabs();
        renderSuggestions(false, 'suggestions', 'prompt'); // show/hide after history loads
        applyTabView();
      }
      if(!splashOnlyMode){
        init();
      } else {
        startSplash();
      }

      document.getElementById('sidebarToggle').addEventListener('click', () => {
        const sb = document.getElementById('sidebar');
        if(sb.style.display === 'none') sb.style.display = '';
        else sb.style.display = 'none';
      });

      const banner = document.getElementById('cookieBanner');
      if(banner){
        if(!localStorage.getItem('cookieAccepted')) banner.style.display = 'block';
        document.getElementById('cookieAcceptBtn').addEventListener('click', () => {
          localStorage.setItem('cookieAccepted', 'yes');
          banner.style.display = 'none';
        });
        document.getElementById('cookieMoreInfoBtn').addEventListener('click', () => {
          window.open('cookies.html', '_blank');
        });
      }
    });

  </script>
  <div id="cookieBanner">
    This site uses session cookies for the functionality of this application such as chat history, preferences, and files.
    <button id="cookieAcceptBtn">Accept</button>
    <button id="cookieMoreInfoBtn">More Info</button>
  </div>
</body>
</html>
